import{d as T,A as Z,r as R,i as ee,a as c,q as j,o as y,b as q,e as C,g as n,w as i,f as v,Q as te,R as ne,I as P,k as z,S as oe,h as S,c as F,T as le,t as H,U as se,V as ae,M as re,W as ce,X as ie,z as U,E as I,Y as pe,Z as L,p as de,m as ue,_ as me,x as J,y as _e,L as fe,N as be,F as he}from"./to-bc85d7a1.js";import{u as Q}from"./to-be912673.js";import{u as K}from"./to-e6870a8d.js";import{s as ve}from"./to-d274ee85.js";import{_ as ye}from"./to-c27b6911.js";const ge=x=>(de("data-v-2f3f30a0"),x=x(),ue(),x),we={class:"dept-tree"},ke={class:"dept-tree__header"},xe=ge(()=>C("div",null,"组织架构",-1)),Ce={class:"dept-tree__op"},Ie={class:"no"},Ne=["onContextmenu"],$e={class:"dept-tree__node"},Me=["onClick"],We=["onClick"],Te=T({name:"dept-list"}),De=T({...Te,props:{drag:{type:Boolean,default:!0},level:{type:Number,default:99}},emits:["refresh","user-add"],setup(x,{emit:g}){const D=x,{service:_,browser:N}=Q(),{ViewGroup:f}=K(),w=Z(),u=R([]),b=R(!1),h=R(!1);function M({data:t}){return t.parentId}function a(t,e){return e.data.parentId}async function l(){b.value=!0,h.value=!1,await _.base.sys.department.list().then(t=>{var e;u.value=re(t),(e=f.value)!=null&&e.selected||p()}),b.value=!1}function p(t){var e;if(t||(t=u.value[0]),t){const s=t.children?ce(t.children).map(o=>o.id):[];s.unshift(t.id),(e=f.value)==null||e.select(t),ie(()=>{g("refresh",{page:1,departmentIds:s})})}}function k(t){var s;const e=t.id?"update":"add";(s=w.value)==null||s.open({title:"编辑部门",width:"550px",props:{labelWidth:"100px"},items:[{label:"部门名称",prop:"name",component:{name:"el-input"},required:!0},{label:"上级部门",prop:"parentName",component:{name:"el-input",props:{disabled:!0}}},{label:"排序",prop:"orderNum",component:{name:"el-input-number",props:{"controls-position":"right",min:0,max:100}}}],form:{...t},on:{submit(o,{done:r,close:m}){_.base.sys.department[e]({id:t.id,parentId:t.parentId,name:o.name,orderNum:o.orderNum}).then(()=>{I.success(`新增部门 “${o.name}” 成功`),m(),l()}).catch(B=>{I.error(B.message),r()})}}},[ve()])}function G(t){async function e(s){await _.base.sys.department.delete({ids:[t.id],deleteUser:s}).then(()=>{var o,r;((r=(o=f.value)==null?void 0:o.selected)==null?void 0:r.id)==t.id&&p(),s?I.success("删除成功"):U.confirm(`“${t.name}” 部门的用户已成功转移到 “${t.parentName}” 部门。`,"删除成功")}),l()}U.confirm(`此操作将会删除 “${t.name}” 部门的所有用户，是否确认？`,"提示",{type:"warning",confirmButtonText:"直接删除",cancelButtonText:"保留用户",distinguishCancelAndClose:!0}).then(()=>{e(!0)}).catch(s=>{s=="cancel"&&e(!1)})}function V(t){t?U.confirm("部门架构已发生改变，是否保存？","提示",{type:"warning"}).then(async()=>{const e=[];function s(o,r){o.forEach(m=>{m.parentId=r,e.push(m),m.children&&me(m.children)&&s(m.children,m.id)})}s(u.value,null),await _.base.sys.department.order(e.map((o,r)=>({id:o.id,parentId:o.parentId,orderNum:r}))).then(()=>{I.success("更新排序成功")}).catch(o=>{I.error(o.message)}),l(),h.value=!1}).catch(()=>null):l()}function W(t,e,s){e||(e=u.value[0]||{});const o=_.base.sys.department.permission;pe.open(t,{list:[{label:"新增",hidden:s&&s.level>=D.level||!L(o.add),callback(r){k({name:"",parentName:e.name,parentId:e.id}),r()}},{label:"编辑",hidden:!L(o.update),callback(r){k(e),r()}},{label:"删除",hidden:!e.parentId||!L(o.delete),callback(r){G(e),r()}},{label:"新增成员",hidden:!L(o.add),callback(r){g("user-add",e),r()}}]})}return ee(function(){l()}),(t,e)=>{const s=c("el-icon"),o=c("el-tooltip"),r=c("el-button"),m=c("el-tree"),B=c("el-scrollbar"),O=c("cl-form"),A=j("loading");return y(),q("div",we,[C("div",ke,[xe,C("ul",Ce,[C("li",{onClick:e[0]||(e[0]=d=>l())},[n(o,{content:"刷新"},{default:i(()=>[n(s,null,{default:i(()=>[n(v(te))]),_:1})]),_:1})]),x.drag&&!v(N).isMini?(y(),q("li",{key:0,onClick:e[1]||(e[1]=d=>h.value=!0)},[n(o,{content:"拖动排序"},{default:i(()=>[n(s,null,{default:i(()=>[n(v(ne))]),_:1})]),_:1})])):P("",!0),z(C("li",Ie,[n(r,{onClick:e[2]||(e[2]=d=>V(!0)),size:"small"},{default:i(()=>[S("保存")]),_:1}),n(r,{onClick:e[3]||(e[3]=d=>V(!1)),size:"small"},{default:i(()=>[S("取消")]),_:1})],512),[[oe,h.value]])])]),C("div",{class:"dept-tree__container",onContextmenu:ae(W,["stop","prevent"])},[n(B,null,{default:i(()=>[z((y(),F(m,{"node-key":"id","default-expand-all":"",data:u.value,props:{label:"name"},draggable:h.value,"allow-drag":M,"allow-drop":a,"expand-on-click-node":!1,onNodeContextmenu:W},{default:i(({node:d,data:$})=>{var E,X;return[C("div",$e,[C("span",{class:le(["dept-tree__node-label",{"is-active":$.id==((X=(E=v(f))==null?void 0:E.selected)==null?void 0:X.id)}]),onClick:Y=>p($)},H(d.label),11,Me),v(N).isMini?(y(),q("span",{key:0,class:"dept-tree__node-icon",onClick:Y=>W(Y,$,d)},[n(s,null,{default:i(()=>[n(v(se))]),_:1})],8,We)):P("",!0)])]}),_:1},8,["data","draggable"])),[[A,b.value]])]),_:1})],40,Ne),n(O,{ref_key:"Form",ref:w},null,512)])}}});const Ve=ye(De,[["__scopeId","data-v-2f3f30a0"]]),Be={class:"dept-move"},Fe=T({name:"user-move"}),qe=T({...Fe,setup(x,{expose:g}){const{service:D}=Q(),_=Z(),N=J();async function f(w){var u;(u=_.value)==null||u.open({title:"部门转移",width:"500px",props:{labelWidth:"80px"},items:[{label:"选择部门",prop:"departmentId",component:{name:"cl-dept-select"}}],on:{submit(b,{done:h,close:M}){if(!b.departmentId)return I.warning("请选择部门"),h();U.confirm("转移到新部门，是否继续？","提示",{type:"warning"}).then(()=>{D.base.sys.user.move({...b,userIds:w}).then(()=>{var a;I.success("转移成功"),(a=N.value)==null||a.refresh(),M()}).catch(a=>{I.error(a.message),h()})}).catch(()=>null)}}})}return g({open:f}),(w,u)=>{const b=c("cl-form");return y(),q("div",Be,[n(b,{ref_key:"Form",ref:_},null,512)])}}}),Se=T({name:"sys-user"}),Ge=T({...Se,setup(x){const{service:g,refs:D,setRefs:_}=Q(),{ViewGroup:N}=K({title:"用户列表"}),f=J({service:g.base.sys.user}),w=_e({columns:[{type:"selection",width:60},{prop:"headImg",label:"头像",component:{name:"cl-avatar"}},{prop:"username",label:"米米号",minWidth:150},{prop:"name",label:"姓名",minWidth:150},{prop:"nickName",label:"昵称",minWidth:150},{prop:"departmentName",label:"部门名称",minWidth:150},{prop:"roleName",label:"角色",headerAlign:"center",minWidth:120},{prop:"status",label:"状态",minWidth:120,component:{name:"cl-switch"}},{prop:"phone",label:"手机号码",minWidth:150},{prop:"remark",label:"备注",minWidth:150},{prop:"createTime",label:"创建时间",sortable:"desc",minWidth:160},{type:"op",buttons:["slot-btn","edit","delete"],width:240}]}),u=fe({dialog:{width:"800px"},items:[{prop:"headImg",label:"头像",component:{name:"cl-upload",props:{text:"选择头像"}}},{prop:"name",label:"姓名",span:12,required:!0,component:{name:"el-input"}},{prop:"nickName",label:"昵称",required:!0,span:12,component:{name:"el-input"}},{prop:"username",label:"米米号",required:!0,span:12,component:{name:"el-input"}},()=>{var a;return{prop:"password",label:"密码",span:12,required:((a=u.value)==null?void 0:a.mode)=="add",component:{name:"el-input",props:{type:"password"}},rules:[{min:6,max:16,message:"密码长度在 6 到 16 个字符"}]}},{prop:"roleIdList",label:"角色",value:[],required:!0,component:{name:"el-select",options:[],props:{multiple:!0,"multiple-limit":3}}},{prop:"phone",label:"手机号码",span:12,component:{name:"el-input"}},{prop:"email",label:"邮箱",span:12,component:{name:"el-input"}},{prop:"remark",label:"备注",component:{name:"el-input",props:{type:"textarea",rows:4}}},{prop:"status",label:"状态",value:1,component:{name:"el-radio-group",options:[{label:"开启",value:1},{label:"关闭",value:0}]}}],onSubmit(a,{next:l}){var p,k;l({...a,departmentId:(k=(p=N.value)==null?void 0:p.selected)==null?void 0:k.id})},async onOpen(){g.base.sys.role.list().then(a=>{var l;(l=u.value)==null||l.setOptions("roleIdList",a.map(p=>({label:p.name||"",value:p.id})))})}});function b(a){var l;(l=f.value)==null||l.refresh(a)}function h({id:a}){var l;(l=f.value)==null||l.rowAppend({departmentId:a})}async function M(a){var p;let l=[];a?l=[a.id]:l=((p=w.value)==null?void 0:p.selection.map(k=>k.id))||[],D.userMove.open(l)}return(a,l)=>{const p=c("cl-refresh-btn"),k=c("cl-add-btn"),G=c("cl-multi-delete-btn"),V=c("el-button"),W=c("cl-flex1"),t=c("cl-search-key"),e=c("cl-row"),s=c("el-tag"),o=c("cl-table"),r=c("cl-pagination"),m=c("cl-upsert"),B=c("cl-crud"),O=c("cl-view-group"),A=j("permission");return y(),F(O,{ref_key:"ViewGroup",ref:N},{left:i(()=>[n(Ve,{onRefresh:b,onUserAdd:h})]),right:i(()=>[n(B,{ref_key:"Crud",ref:f},{default:i(()=>[n(e,null,{default:i(()=>{var d;return[n(p),n(k),n(G),z((y(),F(V,{type:"success",disabled:((d=v(w))==null?void 0:d.selection.length)==0,onClick:l[0]||(l[0]=$=>M())},{default:i(()=>[S("转移")]),_:1},8,["disabled"])),[[A,v(g).base.sys.user.permission.move]]),n(W),n(t,{placeholder:"搜索用户名、姓名"})]}),_:1}),n(e,null,{default:i(()=>[n(o,{ref_key:"Table",ref:w},{"column-roleName":i(({scope:d})=>[d.row.roleName?(y(!0),q(he,{key:0},be(d.row.roleName.split(","),($,E)=>(y(),F(s,{key:E,"disable-transitions":"",size:"small",effect:"dark",style:{margin:"2px"}},{default:i(()=>[S(H($),1)]),_:2},1024))),128)):P("",!0)]),"slot-btn":i(({scope:d})=>[z((y(),F(V,{text:"",bg:"",onClick:$=>M(d.row)},{default:i(()=>[S("转移")]),_:2},1032,["onClick"])),[[A,v(g).base.sys.user.permission.move]])]),_:1},512)]),_:1}),n(e,null,{default:i(()=>[n(W),n(r)]),_:1}),n(m,{ref_key:"Upsert",ref:u},null,512),n(qe,{ref:v(_)("userMove")},null,512)]),_:1},512)]),_:1},512)}}});export{Ge as default};
