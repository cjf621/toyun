var te=Object.defineProperty;var se=(l,s,n)=>s in l?te(l,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[s]=n;var R=(l,s,n)=>(se(l,typeof s!="symbol"?s+"":s,n),n);import{aL as ne,aH as W,r as w,av as G,d as B,u as J,a5 as ae,B as q,a as v,q as O,k as Q,f as o,o as g,b,e,F as Y,g as t,t as N,I as E,w as f,N as X,b0 as oe,ba as le,bb as ce,bc as ie,h as ue,T as H,Y as de,E as _e,ax as re,Q as pe,c as j,a1 as A,G as ve,ah as fe,bd as he,b8 as me,X as ge,ad as xe,aj as ye}from"./to-889985a4.js";import{u as ke}from"./to-32adc42c.js";import{_ as K}from"./to-c27b6911.js";import{u as be}from"./to-92c3899b.js";function P(){return{chat:ne("chat")}}const we=W("chat-message",()=>{const l=w(!1),s=w([]),n=w({page:1,total:0,size:20});async function i(r){l.value=!0,(r==null?void 0:r.page)==1&&(s.value=[]),await G.chat.message.page(r).then(p=>{s.value=p.list.map(a=>(a.content=JSON.parse(a.content),a)),n.value=p.pagination}),l.value=!1}return{loading:l,list:s,pagination:n,get:i}}),$e=W("chat-session",()=>{const l=w(!1),s=w([]),n=w();async function i(p){l.value=!0,await G.chat.session.page(p).then(a=>{n.value||r(a.list[0]),s.value=a.list}),l.value=!1}function r(p){n.value=p}return{loading:l,list:s,value:n,get:i,set:r}});function F(){const l=$e(),s=we();return{session:l,message:s}}const Ce={class:"chat-message","element-loading-text":"消息列表加载中"},Me={class:"head"},Se={class:"avatar"},Te={class:"name"},Ve={class:"avatar"},Ne=["onContextmenu"],Be={class:"h"},Ie={class:"name"},ze={class:"content"},Ue={key:0,class:"is-text"},De={key:1,class:"is-image"},qe={class:"footer"},Ye={class:"tools"},Ee={class:"input"},je=B({name:"undefined"}),He=B({...je,setup(l){const{user:s}=J(),{chat:n}=P(),{message:i,session:r}=F(),{copy:p}=ae(),a=w(""),S=q(()=>{let m=0;return i.list.map(u=>{var y;return u.contentType==1&&(u._index=m++),u.isMy=u.fromId==((y=s.info)==null?void 0:y.id),u})}),h=q(()=>i.list.filter(m=>m.contentType==1).map(m=>{var u;return(u=m.content)==null?void 0:u.imageUrl}).filter(Boolean));function x(){n.send({contentType:0,content:{text:a.value}},!0),a.value=""}function I(m){n.send({contentType:1,content:{imageUrl:m.url}},!0),a.value=""}function V(m,u){de.open(m,{hover:{target:"content"},list:[{label:"复制",callback(y){p(u.content.text||""),_e.success("复制成功"),y()}},{label:"转发"},{label:"删除"}]})}return(m,u)=>{var C,T,M,L;const y=v("cl-avatar"),z=v("el-image"),U=v("el-scrollbar"),$=v("el-icon"),d=v("cl-upload"),D=v("el-input"),_=v("el-button"),c=O("loading");return Q((g(),b("div",Ce,[e("div",Me,[(C=o(r))!=null&&C.value?(g(),b(Y,{key:0},[e("div",Se,[t(y,{size:30,shape:"square",src:(T=o(r))==null?void 0:T.value.avatar},null,8,["src"])]),e("span",Te,"与“"+N((M=o(r))==null?void 0:M.value.nickName)+"”聊天中",1)],64)):E("",!0)]),t(U,{class:"list"},{default:f(()=>[e("ul",null,[(g(!0),b(Y,null,X(o(S),(k,Z)=>(g(),b("li",{key:Z},[e("div",{class:H(["item",{"is-right":k.isMy}])},[e("div",Ve,[t(y,{size:36,shape:"square",src:k.avatar},null,8,["src"])]),e("div",{class:"det",onContextmenu:ee=>{V(ee,k)}},[e("div",Be,[e("span",Ie,N(k.nickName),1)]),e("div",ze,[k.contentType==0?(g(),b("div",Ue,[e("span",null,N(k.content.text),1)])):k.contentType==1?(g(),b("div",De,[t(z,{src:k.content.imageUrl,"preview-src-list":o(h),"initial-index":k._index,"scroll-container":".chat-message .list"},null,8,["src","preview-src-list","initial-index"])])):E("",!0)])],40,Ne)],2)]))),128))])]),_:1}),e("div",qe,[e("div",Ye,[e("ul",null,[t(d,{onSuccess:I,"show-file-list":!1},{default:f(()=>[e("li",null,[t($,null,{default:f(()=>[t(o(oe))]),_:1})])]),_:1}),e("li",null,[t($,null,{default:f(()=>[t(o(le))]),_:1})]),e("li",null,[t($,null,{default:f(()=>[t(o(ce))]),_:1})]),e("li",null,[t($,null,{default:f(()=>[t(o(ie))]),_:1})])])]),e("div",Ee,[t(D,{modelValue:a.value,"onUpdate:modelValue":u[0]||(u[0]=k=>a.value=k),type:"textarea",rows:4,resize:"none",autosize:{minRows:4,maxRows:10},placeholder:"输入内容"},null,8,["modelValue"]),t(_,{type:"success",onClick:x,disabled:!a.value},{default:f(()=>[ue("发送")]),_:1},8,["disabled"])])])])),[[c,(L=o(i))==null?void 0:L.loading]])}}});const Fe=K(He,[["__scopeId","data-v-97a0a812"]]),Le={class:"chat-session"},Re={class:"head"},We={class:"tools"},Ge={class:"list"},Je=["onClick"],Oe={class:"avatar"},Qe={class:"det"},Xe={class:"name"},Ae={class:"message"},Ke={class:"status"},Pe={class:"date"},Ze=B({name:"undefined"}),et=B({...Ze,setup(l){const{browser:s}=A(),{chat:n}=P(),{session:i,message:r}=F(),p=w(""),a=q(()=>(i==null?void 0:i.list.filter(h=>{var x;return(x=h.nickName)==null?void 0:x.includes(p.value)}))||[]);async function S(h){s.isMini&&n.expand(!1),i.set(h),await r.get({page:1}),n.scrollToBottom()}return(h,x)=>{var $;const I=v("el-input"),V=v("el-icon"),m=v("cl-avatar"),u=v("el-badge"),y=v("el-empty"),z=v("el-scrollbar"),U=O("loading");return g(),b("div",Le,[e("div",Re,[t(I,{modelValue:p.value,"onUpdate:modelValue":x[0]||(x[0]=d=>p.value=d),placeholder:"关键字搜索",clearable:""},null,8,["modelValue"]),e("ul",We,[e("li",null,[t(V,null,{default:f(()=>[t(o(re))]),_:1})]),e("li",{onClick:x[1]||(x[1]=d=>o(i).get())},[t(V,null,{default:f(()=>[t(o(pe))]),_:1})])])]),Q((g(),b("div",Ge,[t(z,{class:"scroller"},{default:f(()=>[(g(!0),b(Y,null,X(o(a),(d,D)=>{var _,c;return g(),b("div",{class:H(["item",{"is-active":d.id==((c=(_=o(i))==null?void 0:_.value)==null?void 0:c.id)}]),key:D,onClick:C=>S(d)},[e("div",Oe,[t(u,{value:d.num,hidden:d.num==0},{default:f(()=>[t(m,{shape:"square",src:d.avatar},null,8,["src"])]),_:2},1032,["value","hidden"])]),e("div",Qe,[e("p",Xe,N(d.nickName),1),e("p",Ae,N(d.text),1)]),e("div",Ke,[e("p",Pe,N(d.createTime),1)])],10,Je)}),128)),o(a).length==0?(g(),j(y,{key:0,"image-size":100,description:"暂无会话"})):E("",!0)]),_:1})])),[[U,($=o(i))==null?void 0:$.loading]])])}}});const tt=K(et,[["__scopeId","data-v-e7afd515"]]),st={class:"cl-chat__wrap"},nt={class:"cl-chat__session"},at={class:"cl-chat__right"},ot={class:"cl-dialog__controls-icon"},lt=B({name:"cl-chat"}),rt=B({...lt,setup(l,{expose:s}){ke();const{browser:n,onScreenChange:i}=A(),{session:r,message:p}=F(),{user:a}=J();ve.get("chat");const S=w(!1),h=w(!0);w(parseInt(String(Math.random()*100)));let x;const I=be();class V{constructor(){R(this,"send");this.internalMethod=this.internalMethod.bind(this),this.send=this.internalMethod}internalMethod(c){I.send(c)}}window.To=new V;function m(){D()}function u(){S.value=!0,m()}function y(){S.value=!1}function z(_){h.value=_===void 0?!h.value:_}function U(_,c){c&&$(_)}function $(_){var c,C,T,M;p.list.push({fromId:(c=a.info)==null?void 0:c.id,toId:(C=r.value)==null?void 0:C.userId,avatar:(T=a.info)==null?void 0:T.headImg,nickName:(M=a.info)==null?void 0:M.nickName,createTime:ye().format("YYYY-MM-DD HH:mm:ss"),..._}),d()}const d=fe(()=>{ge(()=>{const _=document.querySelector(".cl-chat .chat-message .list");_==null||_.scroll({top:1e5+Math.random(),behavior:"smooth"})})},300);async function D(){await r.get(),await p.get(),d()}return xe("chat",{get socket(){return x},send:U,append:$,expand:z,scrollToBottom:d}),i(()=>{h.value=!n.isMini}),s({open:u,close:y}),(_,c)=>{const C=v("el-icon"),T=v("cl-dialog");return g(),b("div",st,[t(T,{modelValue:S.value,"onUpdate:modelValue":c[2]||(c[2]=M=>S.value=M),title:"聊天窗口",height:"630px",width:"1200px","keep-alive":"","close-on-click-modal":!1,"close-on-press-escape":"","append-to-body":"",controls:["slot-expand","cl-flex1","fullscreen","close"]},{"slot-expand":f(()=>[e("button",ot,[h.value?(g(),j(C,{key:1,onClick:c[1]||(c[1]=M=>h.value=!1)},{default:f(()=>[t(o(me))]),_:1})):(g(),j(C,{key:0,onClick:c[0]||(c[0]=M=>h.value=!0)},{default:f(()=>[t(o(he))]),_:1}))])]),default:f(()=>[e("div",{class:H(["cl-chat",{"is-mini":o(n).isMini,"is-expand":h.value}])},[e("div",nt,[t(tt)]),e("div",at,[t(Fe)])],2)]),_:1},8,["modelValue"])])}}});export{rt as default};
