import{d as y,A as H,r as I,i as O,a as f,q as J,o as g,b as B,e as u,g as a,w as r,f as w,Q as K,R as ee,I as U,k as W,S as te,h as L,c as P,T as ne,t as oe,U as se,V as ae,M as le,W as re,X as ie,z,E as C,Y as de,Z as $,p as ce,m as ue,_ as pe,x as _e}from"./to-6daecd4d.js";import{u as A}from"./to-e317cdfd.js";import{u as Q}from"./to-0a44f508.js";import{s as me}from"./to-9d079b14.js";import{_ as fe}from"./to-c27b6911.js";import{u as ve}from"./to-0405b573.js";import"./to-d5b99870.js";const be=c=>(ce("data-v-4ce8ddb5"),c=c(),ue(),c),he={class:"dept-tree"},we={class:"dept-tree__header"},ge=be(()=>u("div",null,"脚本菜单",-1)),ye={class:"dept-tree__op"},ke={class:"no"},xe=["onContextmenu"],Ce={class:"dept-tree__node"},Ie=["onClick"],Ne=["onClick"],$e=y({name:"dept-list"}),Be=y({...$e,props:{drag:{type:Boolean,default:!0},level:{type:Number,default:99}},emits:["refresh","user-add"],setup(c,{emit:v}){const D=c,{service:i,browser:k}=A(),{ViewGroup:_}=Q(),N=H(),m=I([]),x=I(!1),l=I(!1);function p({data:t}){return t.parentId}function M(t,e){return e.data.parentId}async function b(){x.value=!0,l.value=!1,await i.web.web.list().then(t=>{var e;m.value=le(t),(e=_.value)!=null&&e.selected||V()}),x.value=!1}function V(t){var e;if(t||(t=m.value[0]),t){const o=t.children?re(t.children).map(n=>n.id):[];o.unshift(t.id),(e=_.value)==null||e.select(t),ie(()=>{v("refresh",{page:1,departmentIds:o})})}}function F(t){var o;const e=t.id?"update":"add";(o=N.value)==null||o.open({title:"编辑部门",width:"550px",props:{labelWidth:"100px"},items:[{label:"部门名称",prop:"name",component:{name:"el-input"},required:!0},{label:"上级部门",prop:"parentName",component:{name:"el-input",props:{disabled:!0}}},{label:"排序",prop:"orderNum",component:{name:"el-input-number",props:{"controls-position":"right",min:0,max:100}}}],form:{...t},on:{submit(n,{done:s,close:d}){i.web.web[e]({id:t.id,parentId:t.parentId,name:n.name,orderNum:n.orderNum}).then(()=>{C.success(`新增部门 “${n.name}” 成功`),d(),b()}).catch(E=>{C.error(E.message),s()})}}},[me()])}function X(t){async function e(o){await i.web.web.delete({ids:[t.id],deleteUser:o}).then(()=>{var n,s;((s=(n=_.value)==null?void 0:n.selected)==null?void 0:s.id)==t.id&&V(),o?C.success("删除成功"):z.confirm(`“${t.name}” 部门的用户已成功转移到 “${t.parentName}” 部门。`,"删除成功")}),b()}z.confirm(`此操作将会删除 “${t.name}” 部门的所有用户，是否确认？`,"提示",{type:"warning",confirmButtonText:"直接删除",cancelButtonText:"保留用户",distinguishCancelAndClose:!0}).then(()=>{e(!0)}).catch(o=>{o=="cancel"&&e(!1)})}function j(t){t?z.confirm("部门架构已发生改变，是否保存？","提示",{type:"warning"}).then(async()=>{const e=[];function o(n,s){n.forEach(d=>{d.parentId=s,e.push(d),d.children&&pe(d.children)&&o(d.children,d.id)})}o(m.value,null),await i.web.web.order(e.map((n,s)=>({id:n.id,parentId:n.parentId,orderNum:s}))).then(()=>{C.success("更新排序成功")}).catch(n=>{C.error(n.message)}),b(),l.value=!1}).catch(()=>null):b()}function S(t,e,o){e||(e=m.value[0]||{});const n=i.base.sys.department.permission;de.open(t,{list:[{label:"新增",hidden:o&&o.level>=D.level||!$(n.add),callback(s){F({name:"",parentName:e.name,parentId:e.id}),s()}},{label:"编辑",hidden:!$(n.update),callback(s){F(e),s()}},{label:"删除",hidden:!e.parentId||!$(n.delete),callback(s){X(e),s()}},{label:"新增成员",hidden:!$(n.add),callback(s){v("user-add",e),s()}}]})}return O(function(){b()}),(t,e)=>{const o=f("el-icon"),n=f("el-tooltip"),s=f("el-button"),d=f("el-tree"),E=f("el-scrollbar"),Y=f("cl-form"),Z=J("loading");return g(),B("div",he,[u("div",we,[ge,u("ul",ye,[u("li",{onClick:e[0]||(e[0]=h=>b())},[a(n,{content:"刷新"},{default:r(()=>[a(o,null,{default:r(()=>[a(w(K))]),_:1})]),_:1})]),c.drag&&!w(k).isMini?(g(),B("li",{key:0,onClick:e[1]||(e[1]=h=>l.value=!0)},[a(n,{content:"拖动排序"},{default:r(()=>[a(o,null,{default:r(()=>[a(w(ee))]),_:1})]),_:1})])):U("",!0),W(u("li",ke,[a(s,{onClick:e[2]||(e[2]=h=>j(!0)),size:"small"},{default:r(()=>[L("保存")]),_:1}),a(s,{onClick:e[3]||(e[3]=h=>j(!1)),size:"small"},{default:r(()=>[L("取消")]),_:1})],512),[[te,l.value]])])]),u("div",{class:"dept-tree__container",onContextmenu:ae(S,["stop","prevent"])},[a(E,null,{default:r(()=>[W((g(),P(d,{"node-key":"id","default-expand-all":"",data:m.value,props:{label:"name"},draggable:l.value,"allow-drag":p,"allow-drop":M,"expand-on-click-node":!1,onNodeContextmenu:S},{default:r(({node:h,data:T})=>{var q,G;return[u("div",Ce,[u("span",{class:ne(["dept-tree__node-label",{"is-active":T.id==((G=(q=w(_))==null?void 0:q.selected)==null?void 0:G.id)}]),onClick:R=>V(T)},oe(h.label),11,Ie),w(k).isMini?(g(),B("span",{key:0,class:"dept-tree__node-icon",onClick:R=>S(R,T,h)},[a(o,null,{default:r(()=>[a(w(se))]),_:1})],8,Ne)):U("",!0)])]}),_:1},8,["data","draggable"])),[[Z,x.value]])]),_:1})],40,xe),a(Y,{ref_key:"Form",ref:N},null,512)])}}});const De=fe(Be,[["__scopeId","data-v-4ce8ddb5"]]),Me={id:"box"},Ve=y({name:"undefined"}),Se=y({...Ve,props:{amisjson:{type:Object,required:!0},debugger:{type:Boolean}},setup(c){const v=c;return A(),ve().onmessage(i=>{}),O(()=>{var i=amisRequire("amis/embed");i.embed("#box",v.amisjson)}),(i,k)=>(g(),B("div",Me))}}),Ee=y({name:"sys-user"}),Re=y({...Ee,setup(c){const{service:v,refs:D,setRefs:i}=A(),{ViewGroup:k}=Q({title:"用户列表"}),_=_e({service:v.web.web});function N(l){var p;(p=_.value)==null||p.refresh(l)}function m({id:l}){var p;(p=_.value)==null||p.rowAppend({departmentId:l})}I(!0),I([]);const x={type:"page",title:"表单页面",body:{type:"form",mode:"horizontal",api:"/saveForm",body:[{label:"Name",type:"input-text",name:"name",onChange:l=>{}},{label:"Email",type:"input-email",name:"email"}]}};return(l,p)=>{const M=f("cl-view-group");return g(),P(M,{ref_key:"ViewGroup",ref:k},{left:r(()=>[a(De,{onRefresh:N,onUserAdd:m})]),right:r(()=>[u("div",null,[a(Se,{amisjson:x})])]),_:1},512)}}});export{Re as default};
