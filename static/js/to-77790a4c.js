import{d as te,al as ue,u as ce,G as de,B as v,_ as Z,cH as pe,r as fe,j as me,n as _e,a as k,o as d,b as w,e as g,T as O,f as l,g as f,w as m,bR as R,I as h,c as x,ac as ge,F as ee,d2 as he,E as M,aa as j,h as be,t as S,cI as ye,cw as ve,k as ke,V as ae,cx as we,S as Se,cv as Ce}from"./to-6daecd4d.js";import{D as ze}from"./to-5599e2c6.js";import{u as xe}from"./to-e317cdfd.js";import{_ as Be,g as $e,a as Ue,b as Ve,c as De}from"./to-d2f83d2f.js";import{_ as Ne}from"./to-c27b6911.js";import"./to-d91d3910.js";import"./to-8f6b0e9e.js";import"./to-862de5a8.js";const Fe={class:"cl-upload__item"},Ie={class:"cl-upload__text"},Ae={class:"cl-upload__name"},Pe={class:"cl-upload__size"},Ee={class:"cl-upload__actions"},Te={key:2,class:"cl-upload__progress"},qe={key:3,class:"cl-upload__error"},Le=te({name:"cl-upload"}),Oe=te({...Le,props:{modelValue:{type:[String,Array],default:()=>[]},type:{type:String,default:"image"},accept:String,multiple:Boolean,limit:Number,limitSize:Number,limitUpload:{type:Boolean,default:!0},size:[String,Number,Array],text:String,prefixPath:{type:String,default:"app"},menu:{type:String,default:"base"},showFileList:{type:Boolean,default:!0},draggable:Boolean,disabled:Boolean,customClass:String,beforeUpload:Function,isSpace:Boolean,isEdit:null,scope:null,isDisabled:Boolean},emits:["update:modelValue","upload","success","error","progress"],setup(p,{expose:le,emit:C}){const o=p;ue(a=>({b4276bd8:l(G)[0],b4276b9a:l(G)[1]}));const{service:I,refs:z,setRefs:B}=xe(),{user:se}=ce(),{options:$}=de.get("upload"),G=v(()=>{const a=o.size||$.size;return(Z(a)?a:[a,a]).map(e=>pe(e)?e+"px":e)}),A=v(()=>o.isDisabled||o.disabled),P=v(()=>A.value||o.isSpace),K=o.limit||$.limit.upload,H=o.limitSize||$.limit.size,J=o.text||$.text,E=v(()=>({Authorization:se.token})),r=fe([]),oe=me({options:{group:"Upload",animation:300,ghostClass:"Ghost",dragClass:"Drag",draggable:".is-drag",disabled:!o.draggable}}),U=v(()=>o.accept||(o.type=="file"?"*":"image/*")),T=v(()=>o.multiple?K-r.value.length>0:r.value.length==0);function Q(a){var e;return o.type=="image"?"image":(e=De(a))==null?void 0:e.value}async function V(a,e){function n(){const t={type:Q(a.name),preload:"",progress:0,url:a.url,uid:a.uid,size:a.size};return t.preload=t.url||(t.type=="image"?window.webkitURL.createObjectURL(a):a.name),e?Object.assign(e,t):o.multiple?(T.value||!o.limitUpload)&&r.value.push(t):r.value=[t],C("upload",t),!0}if(o.beforeUpload){const t=o.beforeUpload(a,e);return he(t)?t.then(n).catch(()=>null):t&&n(),t}else return a.size/1024/1024>=H?(M.error(`上传文件大小不能超过 ${H}MB!`),!1):n()}function W(a){r.value.splice(a,1),D()}function X(){r.value=[]}function re(a){var e;a.type=="image"?(e=z.viewer)==null||e.open(a.preload,r.value.map(n=>n.preload)):window.open(a.url)}async function q(a,e){if(e||(e=r.value.find(t=>t.uid==a.file.uid)),!e)return!1;const n=j("");try{let t=n+"_"+a.file.name;const{mode:u,type:y}=await I.base.comm.uploadMode();return new Promise((L,N)=>{async function s({host:i,preview:_,data:Y}){const F=new FormData;for(const c in Y)F.append(c,Y[c]);u=="cloud"&&(t=[o.prefixPath,o.menu,t].filter(Boolean).join("/")),F.append("key",t),F.append("file",a.file),await I.request({url:i,method:"POST",headers:{"Content-Type":"multipart/form-data"},timeout:6e5,data:F,onUploadProgress(c){e.progress=parseInt(String(c.loaded/c.total*100)),C("progress",e)},proxy:u=="local"}).then(c=>{u==="local"?(e.url=c,e.key=c.replace(/^https?:\/\/[^\/]+/,"")):(e.url=`${_||i}/${t}`,e.key=t),e.fileId=n,e.name=e.preload,C("success",e),L(e.url),D()}).catch(c=>{M.error(c.message),e.error=c.message,C("error",e),N(c)})}u=="local"?s({host:"/admin/base/comm/upload"}):I.base.comm.upload().then(i=>{switch(y){case"cos":s({host:i.url,data:i.credentials});break;case"oss":s({host:i.host,data:{OSSAccessKeyId:i.OSSAccessKeyId,policy:i.policy,signature:i.signature}});break;case"qiniu":s({host:i.uploadUrl,preview:i.publicDomain,data:{token:i.token}});break}}).catch(N)})}catch{M.error("上传配置错误")}}function ne(){return r.value.find(a=>a.progress!=100)}function D(){r.value.find(e=>!e.url)||C("update:modelValue",$e(r.value))}function ie(a){var e,n,t;X(),(e=z.upload)==null||e.clearFiles(),(n=z.upload)==null||n.handleStart(a),(t=z.upload)==null||t.submit()}const b={data:null,open(a){var e;b.data=a,(e=z.space)==null||e.open({limit:a||!o.multiple?1:K})},onConfirm(a){a.forEach(e=>{V({uid:j(),...e},b.data)}),D(),b.data=null}};return _e(()=>o.modelValue,a=>{const e=(Z(a)?a:(a||"").split(",")).filter(Boolean),n=[];r.value=e.map(t=>{const u=r.value.find(y=>t==y.url&&!n.includes(y.uid));return u?(n.push(u.uid),u):{type:Q(t),progress:0,uid:j(),url:t,preload:t}}).filter((t,u)=>o.multiple?!0:u==0)},{immediate:!0}),le({isAdd:T,list:r,check:ne,clear:X,remove:W,upload:ie}),(a,e)=>{const n=k("el-button"),t=k("el-upload"),u=k("el-icon"),y=k("el-image"),L=k("el-progress"),N=k("cl-upload-space");return d(),w(ee,null,[g("div",{class:O(["cl-upload__wrap",[p.customClass]])},[g("div",{class:O(["cl-upload",[`cl-upload--${p.type}`,{"is-disabled":l(A)}]])},[p.type=="file"?(d(),w("div",{key:0,class:"cl-upload__file-btn",onClick:e[0]||(e[0]=s=>b.open())},[f(t,{ref:l(B)("upload"),action:"",accept:l(U),"show-file-list":!1,"before-upload":V,"http-request":q,headers:l(E),multiple:p.multiple,disabled:l(P)},{default:m(()=>[R(a.$slots,"default",{},()=>[f(n,{type:"success"},{default:m(()=>[be(S(l(J)),1)]),_:1})],!0)]),_:3},8,["accept","headers","multiple","disabled"])])):h("",!0),p.showFileList?(d(),x(l(ze),ge({key:1,class:"cl-upload__list",tag:"div",modelValue:r.value,"onUpdate:modelValue":e[2]||(e[2]=s=>r.value=s)},oe.options,{"item-key":"uid",onEnd:D}),{footer:m(()=>[p.type=="image"&&l(T)?(d(),w("div",{key:0,class:"cl-upload__footer",onClick:e[1]||(e[1]=s=>b.open())},[f(t,{ref:l(B)("upload"),action:"",accept:l(U),"show-file-list":!1,"before-upload":V,"http-request":q,headers:l(E),multiple:p.multiple,disabled:l(P)},{default:m(()=>[R(a.$slots,"default",{},()=>[g("div",Fe,[f(u,{size:24},{default:m(()=>[f(l(ye))]),_:1}),g("span",Ie,S(l(J)),1)])],!0)]),_:3},8,["accept","headers","multiple","disabled"])])):h("",!0)]),item:m(({element:s,index:i})=>[p.showFileList?(d(),x(t,{key:0,action:"",class:"is-drag",accept:l(U),"show-file-list":!1,"http-request":_=>q(_,s),"before-upload":_=>{V(_,s)},headers:l(E),disabled:l(P),onClick:_=>b.open(s)},{default:m(()=>[R(a.$slots,"item",{item:s,index:i},()=>[g("div",{class:O(["cl-upload__item",[`is-${s.type}`]])},[s.type=="image"?(d(),x(y,{key:0,src:s.preload,fit:"cover"},null,8,["src"])):(d(),w(ee,{key:1},[g("span",Ae,S(l(Ue)(s.preload))+"."+S(l(ve)(s.preload)),1),g("span",Pe,S(l(Ve)(s.size)),1)],64)),g("div",Ee,[ke(f(u,{onClick:ae(_=>re(s),["stop"])},{default:m(()=>[f(l(we))]),_:2},1032,["onClick"]),[[Se,s.url]]),l(A)?h("",!0):(d(),x(u,{key:0,onClick:ae(_=>W(i),["stop"])},{default:m(()=>[f(l(Ce))]),_:2},1032,["onClick"]))]),s.progress>0&&s.progress<100?(d(),w("div",Te,[f(L,{percentage:s.progress,"show-text":!1},null,8,["percentage"])])):h("",!0),s.error?(d(),w("div",qe,S(s.error),1)):h("",!0)],2)],!0)]),_:2},1032,["accept","http-request","before-upload","headers","disabled","onClick"])):h("",!0)]),_:3},16,["modelValue"])):h("",!0)],2)],2),f(Be,{ref:l(B)("viewer")},null,512),p.isSpace?(d(),x(N,{key:0,ref:l(B)("space"),"show-btn":!1,accept:l(U),onConfirm:b.onConfirm},null,8,["accept","onConfirm"])):h("",!0)],64)}}});const We=Ne(Oe,[["__scopeId","data-v-e51727ac"]]);export{We as default};
