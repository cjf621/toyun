import{d as D,A as Z,r as R,i as ee,a as r,q as j,o as y,b as S,e as C,g as n,w as c,f as v,Q as te,R as ne,I as P,k as q,S as oe,h as A,c as F,T as se,t as H,U as le,V as ae,M as re,W as ce,X as ie,z,E as I,Y as pe,Z as U,p as de,m as ue,_ as _e,x as J,y as me,L as fe,N as be,F as he}from"./to-6daecd4d.js";import{u as Q}from"./to-e317cdfd.js";import{u as K}from"./to-0a44f508.js";import{s as ve}from"./to-9d079b14.js";import{_ as ye}from"./to-c27b6911.js";const ge=x=>(de("data-v-2f3f30a0"),x=x(),ue(),x),ke={class:"dept-tree"},we={class:"dept-tree__header"},xe=ge(()=>C("div",null,"组织架构",-1)),Ce={class:"dept-tree__op"},Ie={class:"no"},Ne=["onContextmenu"],$e={class:"dept-tree__node"},Me=["onClick"],Te=["onClick"],De=D({name:"dept-list"}),Ve=D({...De,props:{drag:{type:Boolean,default:!0},level:{type:Number,default:99}},emits:["refresh","user-add"],setup(x,{emit:g}){const V=x,{service:m,browser:N}=Q(),{ViewGroup:f}=K(),k=Z(),u=R([]),b=R(!1),h=R(!1);function M({data:t}){return t.parentId}function i(t,e){return e.data.parentId}async function s(){b.value=!0,h.value=!1,await m.base.sys.department.list().then(t=>{var e;u.value=re(t),(e=f.value)!=null&&e.selected||p()}),b.value=!1}function p(t){var e;if(t||(t=u.value[0]),t){const l=t.children?ce(t.children).map(o=>o.id):[];l.unshift(t.id),(e=f.value)==null||e.select(t),ie(()=>{g("refresh",{page:1,departmentIds:l})})}}function w(t){var l;const e=t.id?"update":"add";(l=k.value)==null||l.open({title:"编辑部门",width:"550px",props:{labelWidth:"100px"},items:[{label:"部门名称",prop:"name",component:{name:"el-input"},required:!0},{label:"上级部门",prop:"parentName",component:{name:"el-input",props:{disabled:!0}}},{label:"排序",prop:"orderNum",component:{name:"el-input-number",props:{"controls-position":"right",min:0,max:100}}}],form:{...t},on:{submit(o,{done:a,close:_}){m.base.sys.department[e]({id:t.id,parentId:t.parentId,name:o.name,orderNum:o.orderNum}).then(()=>{I.success(`新增部门 “${o.name}” 成功`),_(),s()}).catch(B=>{I.error(B.message),a()})}}},[ve()])}function G(t){async function e(l){await m.base.sys.department.delete({ids:[t.id],deleteUser:l}).then(()=>{var o,a;((a=(o=f.value)==null?void 0:o.selected)==null?void 0:a.id)==t.id&&p(),l?I.success("删除成功"):z.confirm(`“${t.name}” 部门的用户已成功转移到 “${t.parentName}” 部门。`,"删除成功")}),s()}z.confirm(`此操作将会删除 “${t.name}” 部门的所有用户，是否确认？`,"提示",{type:"warning",confirmButtonText:"直接删除",cancelButtonText:"保留用户",distinguishCancelAndClose:!0}).then(()=>{e(!0)}).catch(l=>{l=="cancel"&&e(!1)})}function W(t){t?z.confirm("部门架构已发生改变，是否保存？","提示",{type:"warning"}).then(async()=>{const e=[];function l(o,a){o.forEach(_=>{_.parentId=a,e.push(_),_.children&&_e(_.children)&&l(_.children,_.id)})}l(u.value,null),await m.base.sys.department.order(e.map((o,a)=>({id:o.id,parentId:o.parentId,orderNum:a}))).then(()=>{I.success("更新排序成功")}).catch(o=>{I.error(o.message)}),s(),h.value=!1}).catch(()=>null):s()}function T(t,e,l){e||(e=u.value[0]||{});const o=m.base.sys.department.permission;pe.open(t,{list:[{label:"新增",hidden:l&&l.level>=V.level||!U(o.add),callback(a){w({name:"",parentName:e.name,parentId:e.id}),a()}},{label:"编辑",hidden:!U(o.update),callback(a){w(e),a()}},{label:"删除",hidden:!e.parentId||!U(o.delete),callback(a){G(e),a()}},{label:"新增成员",hidden:!U(o.add),callback(a){g("user-add",e),a()}}]})}return ee(function(){s()}),(t,e)=>{const l=r("el-icon"),o=r("el-tooltip"),a=r("el-button"),_=r("el-tree"),B=r("el-scrollbar"),O=r("cl-form"),E=j("loading");return y(),S("div",ke,[C("div",we,[xe,C("ul",Ce,[C("li",{onClick:e[0]||(e[0]=d=>s())},[n(o,{content:"刷新"},{default:c(()=>[n(l,null,{default:c(()=>[n(v(te))]),_:1})]),_:1})]),x.drag&&!v(N).isMini?(y(),S("li",{key:0,onClick:e[1]||(e[1]=d=>h.value=!0)},[n(o,{content:"拖动排序"},{default:c(()=>[n(l,null,{default:c(()=>[n(v(ne))]),_:1})]),_:1})])):P("",!0),q(C("li",Ie,[n(a,{onClick:e[2]||(e[2]=d=>W(!0)),size:"small"},{default:c(()=>[A("保存")]),_:1}),n(a,{onClick:e[3]||(e[3]=d=>W(!1)),size:"small"},{default:c(()=>[A("取消")]),_:1})],512),[[oe,h.value]])])]),C("div",{class:"dept-tree__container",onContextmenu:ae(T,["stop","prevent"])},[n(B,null,{default:c(()=>[q((y(),F(_,{"node-key":"id","default-expand-all":"",data:u.value,props:{label:"name"},draggable:h.value,"allow-drag":M,"allow-drop":i,"expand-on-click-node":!1,onNodeContextmenu:T},{default:c(({node:d,data:$})=>{var L,X;return[C("div",$e,[C("span",{class:se(["dept-tree__node-label",{"is-active":$.id==((X=(L=v(f))==null?void 0:L.selected)==null?void 0:X.id)}]),onClick:Y=>p($)},H(d.label),11,Me),v(N).isMini?(y(),S("span",{key:0,class:"dept-tree__node-icon",onClick:Y=>T(Y,$,d)},[n(l,null,{default:c(()=>[n(v(le))]),_:1})],8,Te)):P("",!0)])]}),_:1},8,["data","draggable"])),[[E,b.value]])]),_:1})],40,Ne),n(O,{ref_key:"Form",ref:k},null,512)])}}});const We=ye(Ve,[["__scopeId","data-v-2f3f30a0"]]),Be={class:"dept-move"},Fe=D({name:"user-move"}),Se=D({...Fe,setup(x,{expose:g}){const{service:V}=Q(),m=Z(),N=J();async function f(k){var u;(u=m.value)==null||u.open({title:"部门转移",width:"500px",props:{labelWidth:"80px"},items:[{label:"选择部门",prop:"departmentId",component:{name:"cl-dept-select"}}],on:{submit(b,{done:h,close:M}){if(!b.departmentId)return I.warning("请选择部门"),h();z.confirm("转移到新部门，是否继续？","提示",{type:"warning"}).then(()=>{V.base.sys.user.move({...b,userIds:k}).then(()=>{var i;I.success("转移成功"),(i=N.value)==null||i.refresh(),M()}).catch(i=>{I.error(i.message),h()})}).catch(()=>null)}}})}return g({open:f}),(k,u)=>{const b=r("cl-form");return y(),S("div",Be,[n(b,{ref_key:"Form",ref:m},null,512)])}}}),Ae=D({name:"sys-user"}),Ge=D({...Ae,setup(x){const{service:g,refs:V,setRefs:m}=Q(),{ViewGroup:N}=K({title:"用户列表"}),f=J({service:g.base.sys.user}),k=me({columns:[{type:"selection",width:60},{prop:"headImg",label:"头像",component:{name:"cl-avatar"}},{prop:"username",label:"米米号",minWidth:100},{prop:"nickName",label:"昵称",minWidth:80},{prop:"roleName",label:"角色",headerAlign:"center",minWidth:120},{prop:"status",label:"状态",minWidth:120,component:{name:"cl-switch"}},{prop:"remark",label:"备注",minWidth:150},{prop:"createTime",label:"创建时间",sortable:"desc",minWidth:160},{type:"op",buttons:["slot-btn","edit","delete"],width:240}]}),u=fe({dialog:{width:"800px"},items:[{prop:"headImg",label:"头像",component:{name:"cl-upload",props:{text:"选择头像"}}},{prop:"nickName",label:"昵称",required:!0,span:12,component:{name:"el-input"}},{prop:"roleIdList",label:"角色",value:[],required:!0,component:{name:"el-select",options:[],props:{multiple:!0,"multiple-limit":3}}},{prop:"email",label:"邮箱",span:12,component:{name:"el-input"}},{prop:"remark",label:"备注",component:{name:"el-input",props:{type:"textarea",rows:4}}},{prop:"status",label:"状态",value:1,component:{name:"el-radio-group",options:[{label:"开启",value:1},{label:"关闭",value:0}]}}],onSubmit(i,{next:s}){var p,w;s({...i,departmentId:(w=(p=N.value)==null?void 0:p.selected)==null?void 0:w.id})},async onOpen(){g.base.sys.role.list().then(i=>{var s;(s=u.value)==null||s.setOptions("roleIdList",i.map(p=>({label:p.name||"",value:p.id})))})}});function b(i){var s;(s=f.value)==null||s.refresh(i)}function h({id:i}){var s;(s=f.value)==null||s.rowAppend({departmentId:i})}async function M(i){var p;let s=[];i?s=[i.id]:s=((p=k.value)==null?void 0:p.selection.map(w=>w.id))||[],V.userMove.open(s)}return(i,s)=>{const p=r("cl-refresh-btn"),w=r("cl-add-btn"),G=r("cl-multi-delete-btn"),W=r("el-button"),T=r("cl-flex1"),t=r("cl-search-key"),e=r("cl-row"),l=r("el-tag"),o=r("cl-table"),a=r("cl-pagination"),_=r("cl-upsert"),B=r("cl-crud"),O=r("cl-view-group"),E=j("permission");return y(),F(O,{ref_key:"ViewGroup",ref:N},{left:c(()=>[n(We,{onRefresh:b,onUserAdd:h})]),right:c(()=>[n(B,{ref_key:"Crud",ref:f},{default:c(()=>[n(e,null,{default:c(()=>{var d;return[n(p),n(w),n(G),q((y(),F(W,{type:"success",disabled:((d=v(k))==null?void 0:d.selection.length)==0,onClick:s[0]||(s[0]=$=>M())},{default:c(()=>[A("转移")]),_:1},8,["disabled"])),[[E,v(g).base.sys.user.permission.move]]),n(T),n(t,{placeholder:"搜索用户名、姓名"})]}),_:1}),n(e,null,{default:c(()=>[n(o,{ref_key:"Table",ref:k},{"column-roleName":c(({scope:d})=>[d.row.roleName?(y(!0),S(he,{key:0},be(d.row.roleName.split(","),($,L)=>(y(),F(l,{key:L,"disable-transitions":"",size:"small",effect:"dark",style:{margin:"2px"}},{default:c(()=>[A(H($),1)]),_:2},1024))),128)):P("",!0)]),"slot-btn":c(({scope:d})=>[q((y(),F(W,{text:"",bg:"",onClick:$=>M(d.row)},{default:c(()=>[A("转移")]),_:2},1032,["onClick"])),[[E,v(g).base.sys.user.permission.move]])]),_:1},512)]),_:1}),n(e,null,{default:c(()=>[n(T),n(a)]),_:1}),n(_,{ref_key:"Upsert",ref:u},null,512),n(Se,{ref:v(m)("userMove")},null,512)]),_:1},512)]),_:1},512)}}});export{Ge as default};
